(()=>{"use strict";var e={514:e=>{e.exports=require("knex")}},t={};function o(r){var n=t[r];if(void 0!==n)return n.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,o),s.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{const e=require("express");var t=o.n(e);const r=require("express-session");var n=o.n(r),s=function(e,t,o,r){return new(o||(o=Promise))((function(n,s){function i(e){try{a(r.next(e))}catch(e){s(e)}}function c(e){try{a(r.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,c)}a((r=r.apply(e,t||[])).next())}))};const i=new class{constructor(e,t){this.db=o(514)(e),this.table=t,this.createTableIfNotExists()}createTableIfNotExists(){return s(this,void 0,void 0,(function*(){if(!(yield this.db.schema.hasTable(this.table)))try{yield this.db.schema.createTableIfNotExists(this.table,(e=>{e.increments("id").primary(),e.string("title"),e.integer("price"),e.string("thumbnail"),e.integer("timestamp")}))}catch(e){console.error(e)}}))}addProduct(e){return s(this,void 0,void 0,(function*(){try{const t=Date.now();yield this.db.insert(Object.assign(Object.assign({},e),{timestamp:t})).into(this.table)}catch(e){console.log("Method save: ",e)}}))}getAll(){return s(this,void 0,void 0,(function*(){try{return yield this.db.select("*").from(this.table)}catch(e){console.log("Method getAll: ",e)}}))}getById(e){return s(this,void 0,void 0,(function*(){try{return(yield this.db.select("*").where("id",e).from(this.table))||{error:"Product not found"}}catch(e){console.log("Method getById: ",e)}return{error:"fetch item method failed"}}))}updateProduct(e,t){return s(this,void 0,void 0,(function*(){try{yield this.db.where("id",e).update({title:t.name,price:t.price,thumbnail:t.photoURL}).from(this.table)}catch(e){console.log("Method update: ",e)}}))}deleteProduct(e){return s(this,void 0,void 0,(function*(){try{yield this.db.delete("*").where("id",e).from(this.table)}catch(e){console.log("Method deleteById: ",e)}}))}}({client:"mysql",connection:{host:"127.0.0.1",port:3306,user:"root",password:"",database:"clase_24"},pool:{min:0,max:7}},"products"),c=require("fs");var a=o.n(c);const l=require("normalizr"),d=(e,t)=>{const o=new l.schema.Entity("author",{},{idAttribute:"email"}),r=new l.schema.Entity("message",{author:o},{idAttribute:"id"}),n=new l.schema.Entity("messages",{messages:[r]},{idAttribute:"id"});return"normalize"==e?(0,l.normalize)({id:"messages",messages:t},n):(0,l.denormalize)(t.result,n,t.entities)},u=require("util");var m=o.n(u),p=function(e,t,o,r){return new(o||(o=Promise))((function(n,s){function i(e){try{a(r.next(e))}catch(e){s(e)}}function c(e){try{a(r.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,c)}a((r=r.apply(e,t||[])).next())}))};function h(e){console.log(m().inspect(e,!1,12,!0))}const f=new class extends class{constructor(e){this.filePath=e}}{constructor(){super("./DB/chat.json")}readChatFromFile(){return p(this,void 0,void 0,(function*(){try{const e=yield a().promises.readFile(this.filePath,"utf8"),t=JSON.parse(e),o=d("denormalize",t);return console.log("Denormalized"),h(o),o}catch(e){console.log("File cannot be read "+e)}}))}writeChatToFile(e){return p(this,void 0,void 0,(function*(){try{const t=d("normalize",e);console.log("Normalized"),h(t),yield a().promises.writeFile(this.filePath,JSON.stringify(t))}catch(e){console.log("File cannot be written "+e)}}))}},v=require("mongoose");var g=o.n(v);const y=require("bcrypt");var w=o.n(y),b=function(e,t,o,r){return new(o||(o=Promise))((function(n,s){function i(e){try{a(r.next(e))}catch(e){s(e)}}function c(e){try{a(r.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,c)}a((r=r.apply(e,t||[])).next())}))};const x=new(g().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0}},{collection:"users"});x.pre("save",(function(e){return b(this,void 0,void 0,(function*(){const t=this;try{const o=yield w().genSalt(10),r=yield w().hash(t.password,o);t.password=r,e()}catch(t){e(t)}}))})),x.methods.comparePassword=(e,t)=>b(void 0,void 0,void 0,(function*(){return yield w().compareSync(e,t)}));const q=g().model("User",x),P=require("dotenv");var O=o.n(P);const N=require("path");var M=o.n(N);const R=require("minimist");var S=o.n(R);(0,P.config)({path:N.resolve(__dirname,"../../.env")});const I={admin:!0,hostNanme:"http://localhost:8080",PORT:process.argv[2]||parseInt(process.env.PORT)},U=S()(process.argv.slice(2),{alias:{m:"modo",p:"port",d:"debug"},default:{modo:"prod",port:8080,debug:!1}});O().config();const z={mongoDB:{URI:`mongodb+srv://${process.env.MONGOUSR}:${process.env.MONGOPWD}@${process.env.MONGOCLUSTER}.mongodb.net/?retryWrites=true&w=majority`}},D=require("connect-mongo");var E=o.n(D);const T=require("socket.io"),$=require("connect-flash");var _=o.n($);const j=require("cookie-parser");var A=o.n(j);const C=require("passport");var F=o.n(C);const B=require("cluster");var k=o.n(B);const J=require("os");var Y=o.n(J);const G=require("child_process"),L=require("winston");var W=o.n(L);O().config();const H=process.env.ENVIRONMENT_MODE||"development";W().addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const K=W().format.combine(W().format.timestamp({format:"DD-MM-YYYY HH:mm:ss:ms"}),W().format.printf((e=>`${e.timestamp} ${e.level}: ${e.message}`))),V=[new(W().transports.Console)({format:W().format.combine(W().format.colorize({all:!0}),K)}),new(W().transports.File)({filename:"logs/warn.log",level:"warn",format:K}),new(W().transports.File)({filename:"logs/error.log",level:"error",format:K})],Q=W().createLogger({level:"development"===H?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},transports:V}),X=(0,e.Router)();X.get("/",((e,t)=>{const{amount:o}=e.query;let r=Number(o);r||(r=1e8);const n=(0,G.fork)("./api/utils/getRandom.js");n.send(r),n.on("message",(e=>{t.end(JSON.stringify(e,null,3))})),n.on("exit",(e=>{Q.info("Se ha cerrado el proceso",e)}))}));const Z=X,ee=(0,e.Router)();ee.get("/",((e,t)=>{const o=Y().cpus().length,r={title:process.argv,arguments:process.argv,system:process.platform,version:process.version,memory:process.memoryUsage.rss(),path:process.execPath,id:process.pid,folder:process.cwd(),procesors:o};return console.log(r),t.render("info",r)}));const te=ee,oe=require("compression");var re=o.n(oe),ne=function(e,t,o,r){return new(o||(o=Promise))((function(n,s){function i(e){try{a(r.next(e))}catch(e){s(e)}}function c(e){try{a(r.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,c)}a((r=r.apply(e,t||[])).next())}))};Q.info("Informaci√≥n"),Q.debug("Debug"),Q.warn("Advertencia"),Q.error("Error");const se=U.p||process.env.PORT||I.PORT||8080,ie=t()();if("cluster"===process.argv[3]&&k().isPrimary){const e=Y().cpus().length;Q.info(`Number of CPUs: ${e}`),Q.info(`Master PID ${process.pid} is running`);for(let t=0;t<e;t++)k().fork();k().on("exit",(e=>{Q.info(`Worker ${e.process.pid} died`),k().fork()}))}else{ie.use("/api/randoms",Z);const e=ie.listen(se,(()=>{Q.info(`Server listening on port ${se}.`,`Process ID: ${process.pid}.`)}));e.on("error",(e=>Q.error(`An error has ocurred when starting: ${e}`)));const t=new T.Server(e);let o=[];t.on("connection",(e=>ne(void 0,void 0,void 0,(function*(){e.emit("server:products",yield i.getAll()),e.emit("server:message",o),e.on("client:product",(e=>ne(void 0,void 0,void 0,(function*(){i.addProduct(e),t.emit("server:products",yield i.getAll())})))),e.on("client:message",(e=>ne(void 0,void 0,void 0,(function*(){e.id=o.length+1,o.push(e),f.writeChatToFile(o);const r=o,n=d("normalize",o),s=JSON.stringify(n).length,i=JSON.stringify(r).length;let c=Math.round(100*s/i);console.log(`Compression Rate: ${(100-c).toFixed(2)}%`),t.emit("server:message",o)}))))}))))}ie.use(t().static(M().join(__dirname,"../public"))),ie.use(t().json()),ie.use(A()()),ie.use(t().urlencoded({extended:!0})),ie.set("views",M().join(__dirname,"../api/views")),ie.set("view engine","ejs");const ce={useNewUrlParser:!0,useUnifiedTopology:!0};ie.use(n()({store:E().create({mongoUrl:z.mongoDB.URI,mongoOptions:ce}),secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),g().connect(z.mongoDB.URI,ce,(e=>{try{Q.info("Connected to MongoDB Atlas")}catch(e){throw e}})),ie.use(F().initialize()),ie.use(F().session()),ie.use(_()()),F().serializeUser(((e,t)=>{t(null,e._id)})),F().deserializeUser(((e,t)=>ne(void 0,void 0,void 0,(function*(){const o=yield q.findById(e);t(null,o)})))),ie.use("/info",te),ie.use("/infoCompressed",re()(),te)})()})();