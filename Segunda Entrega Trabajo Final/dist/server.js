(()=>{"use strict";var e,t={407:(e,t,o)=>{o.d(t,{Z:()=>i});var n=o(185),r=o.n(n);const d="mongodb+srv://giulianogiova:coderhouse@cluster0.d9grp.mongodb.net/?retryWrites=true&w=majority";const i=class{constructor(e){this.model=e,this.connect()}connect(){return e=this,t=void 0,n=function*(){try{yield r().connect(d),console.log("connected to mongoDB Atlas")}catch(e){console.log(e)}},new((o=void 0)||(o=Promise))((function(r,d){function i(e){try{s(n.next(e))}catch(e){d(e)}}function c(e){try{s(n.throw(e))}catch(e){d(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,c)}s((n=n.apply(e,t||[])).next())}));var e,t,o,n}}},463:(e,t,o)=>{o.r(t),o.d(t,{default:()=>a});var n=o(407),r=o(185),d=o.n(r);const i=new(d().Schema)({products:[{product:{type:Object,ref:"products"}}],quantity:{type:Number,required:!0,default:1},timestamp:{type:Number,required:!0,default:Date.now}}),c=d().model("carts",i);var s=function(e,t,o,n){return new(o||(o=Promise))((function(r,d){function i(e){try{s(n.next(e))}catch(e){d(e)}}function c(e){try{s(n.throw(e))}catch(e){d(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,c)}s((n=n.apply(e,t||[])).next())}))};class u extends n.Z{constructor(){super(c)}createNewCart(){return s(this,void 0,void 0,(function*(){try{const e=new this.model({}),{_id:t}=yield e.save();return t}catch(e){console.log(e)}}))}deleteCartById(e){return s(this,void 0,void 0,(function*(){try{const t=yield this.model.findOne({_id:e});if(null===t)return{error:"Cart not found"};yield t.remove()}catch(e){console.log(e)}}))}getProductsByCartId(e){return s(this,void 0,void 0,(function*(){try{const t=yield this.model.findOne({_id:e});return null===t?{error:"Cart not found"}:t.products}catch(e){console.log(e)}}))}addProductsById(e,t){return s(this,void 0,void 0,(function*(){try{return null===(yield this.model.findOne({_id:e}))?{error:"Cart not found"}:0===(yield this.model.updateOne({_id:e},{$push:{products:{product:t}}})).modifiedCount?{error:"Product not added."}:{msg:"Product added."}}catch(e){console.log(e)}}))}deleteProductByCartId(e,t){return s(this,void 0,void 0,(function*(){try{if(null===(yield this.model.findOne({_id:e})))return{error:"Cart not found"};{const o=yield this.model.updateOne({_id:e},{$pull:{products:{product:{id:t}}}});return console.log(o),0===o.modifiedCount?{error:"Product not found."}:{msg:"Product deleted."}}}catch(e){console.log(e)}}))}}const a=new u},11:(e,t,o)=>{o.r(t),o.d(t,{default:()=>a});var n=o(407),r=o(185),d=o.n(r);const i=new(d().Schema)({name:{type:String,required:!0,minlength:3,maxlength:70},price:{type:Number,required:!0,min:0},description:{type:String,required:!0,minlength:6,maxlength:200},photoURL:{type:String,required:!0,minlength:8,maxlength:200},stock:{type:Number,required:!0,min:0},timestamp:{type:Number,required:!0,default:Date.now}}),c=d().model("products",i);var s=function(e,t,o,n){return new(o||(o=Promise))((function(r,d){function i(e){try{s(n.next(e))}catch(e){d(e)}}function c(e){try{s(n.throw(e))}catch(e){d(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,c)}s((n=n.apply(e,t||[])).next())}))};class u extends n.Z{constructor(){super(c)}getAll(){return s(this,void 0,void 0,(function*(){try{return yield this.model.find({})}catch(e){console.log(e)}}))}getById(e){return s(this,void 0,void 0,(function*(){try{const t=yield this.model.findOne({_id:e},{__v:0});return null===t?{error:"Product not found"}:t}catch(e){console.log("Method getById: ",e)}}))}addProduct(e){return s(this,void 0,void 0,(function*(){try{const t=new this.model(e);return yield t.save()}catch(e){console.log(e)}}))}updateProduct(e,t){return s(this,void 0,void 0,(function*(){try{return 0===(yield this.model.updateOne({_id:e},t)).matchedCount?{error:"Product not found."}:{msg:`Product ${e} updated!`}}catch(e){console.log("Method update: ",e)}}))}deleteProduct(e){return s(this,void 0,void 0,(function*(){try{return 0===(yield this.model.deleteOne({_id:e})).deletedCount?{error:"Product not found."}:{msg:"Product deleted."}}catch(e){console.log("Method deleteById: ",e)}}))}}const a=new u},509:e=>{e.exports=require("firebase-admin")},185:e=>{e.exports=require("mongoose")},147:e=>{e.exports=require("fs")}},o={};function n(e){var r=o[e];if(void 0!==r)return r.exports;var d=o[e]={exports:{}};return t[e](d,d.exports,n),d.exports}n.m=t,n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,o)=>(n.f[o](e,t),t)),[])),n.u=e=>e+".server.js",n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},e={179:1},n.f.require=(t,o)=>{e[t]||(t=>{var o=t.modules,r=t.ids,d=t.runtime;for(var i in o)n.o(o,i)&&(n.m[i]=o[i]);d&&d(n);for(var c=0;c<r.length;c++)e[r[c]]=1})(require("./"+n.u(t)))},(()=>{const e=require("express");var t=n.n(e);const o=require("dotenv");var r=n.n(o);let d,i;switch(r().config(),process.env.DB_PROVIDER){case"mongodb":Promise.resolve().then(n.bind(n,11)).then((e=>d=e.default)),Promise.resolve().then(n.bind(n,463)).then((e=>i=e.default));break;case"firebase":n.e(825).then(n.bind(n,825)).then((e=>d=e.default)),n.e(489).then(n.bind(n,489)).then((e=>i=e.default));break;case"fs":n.e(197).then(n.bind(n,197)).then((e=>d=e.default)),n.e(287).then(n.bind(n,287)).then((e=>i=e.default));break;default:d=n(11),i=n(463)}var c=function(e,t,o,n){return new(o||(o=Promise))((function(r,d){function i(e){try{s(n.next(e))}catch(e){d(e)}}function c(e){try{s(n.throw(e))}catch(e){d(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,c)}s((n=n.apply(e,t||[])).next())}))},s=function(e,t,o,n){return new(o||(o=Promise))((function(r,d){function i(e){try{s(n.next(e))}catch(e){d(e)}}function c(e){try{s(n.throw(e))}catch(e){d(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,c)}s((n=n.apply(e,t||[])).next())}))};const u=(0,e.Router)();u.get("/products",((e,t)=>c(void 0,void 0,void 0,(function*(){const e=yield d.getAll();t.json(e)})))),u.get("/products/:id",((e,t)=>c(void 0,void 0,void 0,(function*(){const{id:o}=e.params,n=yield d.getById(o);t.json(n)})))),u.post("/products",((e,t)=>c(void 0,void 0,void 0,(function*(){const o=e.body,n=yield d.addProduct(o);t.json(n)})))),u.put("/products/:id",((e,t)=>c(void 0,void 0,void 0,(function*(){const{id:o}=e.params,n=e.body,r=yield d.updateProduct(o,n);t.json(r)})))),u.delete("/products/:id",((e,t)=>c(void 0,void 0,void 0,(function*(){const{id:o}=e.params,n=yield d.deleteProduct(o);t.json({deletedProduct:n})})))),u.post("/cart/",((e,t)=>s(void 0,void 0,void 0,(function*(){const e=yield i.createNewCart();t.json(e)})))),u.delete("/cart/:id",((e,t)=>s(void 0,void 0,void 0,(function*(){const{id:o}=e.params,n=yield i.deleteCartById(o);return n instanceof Error?t.status(500).json({error:-1,msg:n.message}):-1===n?t.status(500).json({error:-1,msg:"Cart file is empty!"}):-2===n?t.status(500).json({error:-2,msg:`There is no cart with id= ${o}`}):void t.json(`Cart id: ${o} deleted.`)})))),u.get("/cart/:id/products",((e,t)=>s(void 0,void 0,void 0,(function*(){const{id:o}=e.params,n=yield i.getProductsByCartId(o);if(n instanceof Error)return t.status(500).json({error:-1,msg:n.message});t.json(n)})))),u.post("/cart/:id/products",((e,t)=>s(void 0,void 0,void 0,(function*(){const{id:o}=e.params,n=e.body,r=yield i.addProductsById(o,n);if(r instanceof Error)return t.status(500).json({error:-1,msg:r.message});t.json(r)})))),u.delete("/cart/:id/products/:id_prod",((e,t)=>s(void 0,void 0,void 0,(function*(){const{id:o,id_prod:n}=e.params,r=yield i.deleteProductByCartId(o,n);if(r instanceof Error)return t.status(500).json({error:-1,msg:r.message});t.json(r)}))));const a=u;r().config();const l=process.env.PORT,f=t()();f.use(t().static(`${__dirname}/public`)),f.use(t().json()),f.use(t().urlencoded({extended:!0})),f.use(((e,t,o)=>{const{isAdmin:n}=e.query;if(!e.originalUrl.includes("/api/cart")&&"true"!==n&&"GET"!==e.method)return t.status(401).json({error:-1,msg:`${e.method}: ${e.originalUrl} --\x3e Unauthorized`});o()})),f.use("/api",a),f.use(((e,t,o)=>{if(!e.originalUrl.includes("/api/cart")||!e.originalUrl.includes("/api/products"))return t.status(401).json({error:-2,msg:`${e.method}: ${e.originalUrl} --\x3e Not implemented`});o()})),f.listen(l,(()=>{console.log(`Server listening on port: ${l}`)}))})()})();