(()=>{"use strict";var e={514:e=>{e.exports=require("knex")}},t={};function o(n){var r=t[n];if(void 0!==r)return r.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,o),i.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{const e=require("express");var t=o.n(e);const n=require("dotenv");var r=o.n(n);const i=require("path");var s=o.n(i);const c=require("socket.io");var l=function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{l(n.next(e))}catch(e){i(e)}}function c(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}l((n=n.apply(e,t||[])).next())}))};const a=new class{constructor(e,t){this.db=o(514)(e),this.table=t,this.createTableIfNotExists()}createTableIfNotExists(){return l(this,void 0,void 0,(function*(){if(!(yield this.db.schema.hasTable(this.table)))try{yield this.db.schema.createTableIfNotExists(this.table,(e=>{e.increments("id").primary(),e.string("title"),e.integer("price"),e.string("thumbnail"),e.integer("timestamp")}))}catch(e){console.error(e)}}))}addProduct(e){return l(this,void 0,void 0,(function*(){try{const t=Date.now();yield this.db.insert(Object.assign(Object.assign({},e),{timestamp:t})).into(this.table)}catch(e){console.log("Method save: ",e)}}))}getAll(){return l(this,void 0,void 0,(function*(){try{return yield this.db.select("*").from(this.table)}catch(e){console.log("Method getAll: ",e)}}))}getById(e){return l(this,void 0,void 0,(function*(){try{return(yield this.db.select("*").where("id",e).from(this.table))||{error:"Product not found"}}catch(e){console.log("Method getById: ",e)}return{error:"fetch item method failed"}}))}updateProduct(e,t){return l(this,void 0,void 0,(function*(){try{yield this.db.where("id",e).update({title:t.name,price:t.price,thumbnail:t.photoURL}).from(this.table)}catch(e){console.log("Method update: ",e)}}))}deleteProduct(e){return l(this,void 0,void 0,(function*(){try{yield this.db.delete("*").where("id",e).from(this.table)}catch(e){console.log("Method deleteById: ",e)}}))}}({client:"mysql",connection:{host:"127.0.0.1",port:3306,user:"root",password:"",database:"clase_24"},pool:{min:0,max:7}},"products"),d=require("fs");var u=o.n(d);const h=require("normalizr"),v=(e,t)=>{const o=new h.schema.Entity("author",{},{idAttribute:"email"}),n=new h.schema.Entity("message",{author:o},{idAttribute:"id"}),r=new h.schema.Entity("messages",{messages:[n]},{idAttribute:"id"});return"normalize"==e?(0,h.normalize)({id:"messages",messages:t},r):(0,h.denormalize)(t.result,r,t.entities)},g=require("util");var m=o.n(g),f=function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{l(n.next(e))}catch(e){i(e)}}function c(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}l((n=n.apply(e,t||[])).next())}))};function p(e){console.log(m().inspect(e,!1,12,!0))}const y=new class extends class{constructor(e){this.filePath=e}}{constructor(){super("./DB/chat.json")}readChatFromFile(){return f(this,void 0,void 0,(function*(){try{const e=yield u().promises.readFile(this.filePath,"utf8"),t=JSON.parse(e),o=v("denormalize",t);return console.log("Denormalized"),p(o),o}catch(e){console.log("File cannot be read "+e)}}))}writeChatToFile(e){return f(this,void 0,void 0,(function*(){try{const t=v("normalize",e);console.log("Normalized"),p(t),yield u().promises.writeFile(this.filePath,JSON.stringify(t))}catch(e){console.log("File cannot be written "+e)}}))}},b=require("cookie-parser");var w=o.n(b);const x=require("express-session");var O=o.n(x);const P=require("connect-mongo");var N=o.n(P);r().config();const j={mongoDB:{URI:`mongodb+srv://${process.env.MONGOUSR}:${process.env.MONGOPWD}@${process.env.MONGOCLUSTER}.mongodb.net/?retryWrites=true&w=majority`}};var q=function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{l(n.next(e))}catch(e){i(e)}}function c(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}l((n=n.apply(e,t||[])).next())}))};r().config();const z=process.env.PORT,A=t()(),M=A.listen(z,(()=>{console.log(`Server listening on port: ${z}`)})),F=new c.Server(M);A.use(t().static(s().join(__dirname,"../public"))),A.use(t().json()),A.use(w()()),A.use(t().urlencoded({extended:!0})),A.set("views",s().join(__dirname,"../public")),A.set("view engine","ejs"),A.use(O()({store:N().create({mongoUrl:j.mongoDB.URI,mongoOptions:{useNewUrlParser:!0,useUnifiedTopology:!0}}),secret:"coderhouse",resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:3e4}})),A.get("/",(function(e,t,o){var n;(null===(n=e.session)||void 0===n?void 0:n.user)?(console.log("Acá llego, SI existe sesion"),o()):(console.log("Acá llego, NO existe sesion"),t.redirect("/login"))}),((e,t)=>{const o=e.session.user.user;t.render("home.ejs",{userName:o})})),A.get("/login",((e,t)=>{if(e.session.user)return t.redirect("/");t.render("login.ejs")})),A.post("/login",((e,t)=>{try{const o=e.body;e.session.user=o,t.redirect("/")}catch(e){t.json({error:!0,message:e})}})),A.get("/logout",((e,t)=>{var o,n;if(null===(o=e.session)||void 0===o?void 0:o.user){const o=(null===(n=e.session)||void 0===n?void 0:n.user).user;return e.session.destroy((e=>console.log(e))),t.render("logout.ejs",{userName:o})}t.redirect("/login")}));let I=[];F.on("connection",(e=>q(void 0,void 0,void 0,(function*(){e.emit("server:products",yield a.getAll()),e.emit("server:message",I),e.on("client:product",(e=>q(void 0,void 0,void 0,(function*(){a.addProduct(e),F.emit("server:products",yield a.getAll())})))),e.on("client:message",(e=>q(void 0,void 0,void 0,(function*(){e.id=I.length+1,I.push(e),y.writeChatToFile(I);const t=I,o=v("normalize",I),n=JSON.stringify(o).length,r=JSON.stringify(t).length;let i=Math.round(100*n/r);console.log(`Compression Rate: ${(100-i).toFixed(2)}%`),F.emit("server:message",I)}))))}))))})()})();